---
title: "BurdenAnalysis"
format: html
editor: visual
---

## GBM Exome Analysis

Hierarchical clustering (12/1/23) and rare variant burden analysis (5/1/24)

## Setting up packages:

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
require(dplyr)
require(survminer)
require(stringr)
require(pvclust)
require(survival)
require(readxl)
require(readr)
require(ggplot2)
require(cluster)
require(ggdendro)
require(ggcorrplot)
library(MesKit)
library(VariantAnnotation)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(org.Hs.eg.db)

BiocManager::install("trackViewer")
#BiocManager::install("TxDb.Hsapiens.UCSC.hg19.knownGene")
#BiocManager::install("VariantAnnotation")
#BiocManager::install("org.Hs.eg.db")


```

## Utility Functions

Utility functions for removing spaces from column names and returning values for zero sum.\

```{r}
library(GenVisR)
```

```{r}
library(trackViewer)
```

```{r}
# Install Bioconductor if not already installed
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}
```

```{r}
is_zero <- function(n){
  val=ifelse(n==0, FALSE, TRUE)
  return(val)
}

is_na <- function(n){
  val=ifelse(!is.na(n), FALSE, TRUE)
  return(val)
}

inject.dots <- function(df) {names(df) <- sub(" ", ".", names(df));df}
```

## Read in and clean data

Read in exome data (Caris) and clinical data (seizure)

```{r}
Caris = read_excel('CARIS Data_6-2-24 with Clinical Info_deidentified.xlsx', sheet=1)
clinical = read_excel('CARIS Data_6-2-24 with Clinical Info_deidentified.xlsx', sheet = 2)


transcripts = read_excel("Raw CARIS Data_8-18-24_deidentified.xlsx", sheet=1)

transcripts2 = read_excel("Raw CARIS Data_8-18-24_deidentified.xlsx", sheet=2)

transcripts3 = read_excel("Raw CARIS Data_8-18-24_deidentified.xlsx", sheet=3)

transcripts4 = read_excel("Raw CARIS Data_8-18-24_deidentified.xlsx", sheet=4)

names(Caris)=make.names(names(Caris))
names(clinical)=make.names(names(clinical))
names(transcripts)=make.names(names(transcripts))
names(transcripts2)=make.names(names(transcripts2))
names(transcripts3)=make.names(names(transcripts3))
names(transcripts4)=make.names(names(transcripts4))

# Drop and rename duplicate columns
#Caris <- Caris %>% dplyr::select(-c(`MN1.Fusion...341`,`TP53.Mutation...564`)) %>% rename(`TP53.Mutation`=`TP53.Mutation...565`) %>% rename(`MN1.Fusion`=`MN1.Fusion...342`)
```

Add clinical column for presence of any seizures (pre or post diagnosis and surgery)

```{r}
clinical$Seizure.presentation.ANY = clinical$Seizure.presentation..0.No..1.Yes. | clinical$Seizure.presentation.ONLY.after.surgery
```

```{r}

library(tidyr)

egfr_mutations = transcripts4 %>% filter(test=="EGFR")

egfr_mutations <- egfr_mutations %>% tidyr::separate_wider_delim(value,  delim="|c.", names=c("protein_change", "variant_description"))


# Split into two columns: position and mutation
#egfr_mutations <- separate(egfr_mutations, variant_description, into = c("Position", "Mutation"), sep = "(?<=[0-9])")

egfr_mutations$Position <- str_extract(egfr_mutations$variant_description, "[0-9]+")
egfr_mutations$Mutation <- str_extract(egfr_mutations$variant_description, "[A-Za-z]+>[A-Za-z]+")


# Display the result
print(egfr_mutations)

grouped_egfr = egfr_mutations %>% group_by(protein_change,Position) %>% summarise(n=n())

grouped_egfr$Position = as.numeric(grouped_egfr$Position)+55019017

egfr_mutations$Hugo_Symbol = egfr_mutations$test
egfr_mutations$Protein_Change = egfr_mutations$protein_change
egfr_mutations$Chromosome = 7
egfr_mutations$Start_Position = egfr_mutations$Position
egfr_formatted = egfr_mutations %>% dplyr::select(Hugo_Symbol, Protein_Change, Chromosome, Start_Position)
write_tsv(egfr_formatted, file = "./egfr_formatted.tsv")


tp53_mutations = transcripts4 %>% filter(test=="TP53")

tp53_mutations <- tp53_mutations %>% tidyr::separate_wider_delim(value,  delim="|c.", names=c("protein_change", "variant_description"), too_few = "align_start")

tp53_mutations$Position <- str_extract(tp53_mutations$variant_description, "[0-9]+")
tp53_mutations$Mutation <- str_extract(tp53_mutations$variant_description, "[A-Za-z]+>[A-Za-z]+")

tp53_mutations$Hugo_Symbol = tp53_mutations$test
tp53_mutations$Protein_Change = tp53_mutations$protein_change
tp53_mutations$Chromosome = 7
tp53_mutations$Start_Position = tp53_mutations$Position
tp53_formatted = tp53_mutations %>% dplyr::select(Hugo_Symbol, Chromosome, Start_Position, Protein_Change)
write_tsv(tp53_formatted, file = "./tp53_formatted.tsv")



tert_mutations = transcripts4 %>% filter(test=="TERT")

#tert_mutations <- tert_mutations %>% tidyr::separate_wider_delim(value,  delim="c.", names=c("protein_change", "variant_description"))

tert_mutations$Position <- str_extract(tert_mutations$value, "-[0-9]+")
tert_mutations$Mutation <- str_extract(tert_mutations$value, "[A-Za-z]+>[A-Za-z]+")

tert_mutations$Hugo_Symbol = tert_mutations$test
#tert_mutations$Protein_Change = tert_mutations$protein_change
tert_mutations$Chromosome = 5
tert_mutations$Start_Position = tert_mutations$Position
tert_formatted = tert_mutations %>% dplyr::select(Hugo_Symbol, Chromosome, Start_Position)
write_tsv(tert_formatted, file = "./tert_formatted.tsv")
```

## Remove poor quality samples

Samples with TMB/MSI/HLA given as \["NA", "QNS" or "Quality Not Sufficient"\]

```{r}
Caris <- Caris %>% filter(!(MSI %in% c("NA", "QNS", "Quality Not Sufficient")))
quality_samples= Caris$Deidentified.code

clinical <- clinical %>% filter(Deidentified.code %in% quality_samples)
```

Count incidences per column

```{r}
id_cols = c("Deidentified.code","TMB","MSI","LOH","HLA.A","HLA.B","HLA.C")

allcounts <- colSums((Caris != 0))
varcounts_genes <- colSums((Caris %>% dplyr::select(-all_of(id_cols)) != 0))
unique_values_per_column <- lapply(Caris, unique)
varcounts_pp <- apply(Caris %>% dplyr::select(-all_of(id_cols)), 1, function(row) sum(row != 0))
```

Remove zero counts (sequenced genes with no mutation, copy number change or fusion events across the cohort)

```{r}

Caris_red <- Caris[allcounts>0]
Caris_red <- Caris_red %>% na.omit()
Caris_red$TP53.Mutation = Caris_red$TP53.Mutation...564
Caris_red <- Caris_red %>% dplyr::select(-c(TP53.Mutation...564, TP53.Mutation...565))

#Recode LOH factors
Caris_red$LOH=ifelse(Caris_red$LOH %in% c('Quality Not Sufficient','QNS','NA'), 
                     NA, Caris_red$LOH)
Caris_red$MSI=ifelse(Caris_red$MSI %in% c('Quality Not Sufficient','QNS','NA'), 
                     NA, Caris_red$MSI)
# Recode TMB
Caris_red$TMB_numeric = as.numeric(substr(Caris_red$TMB,1,2))

# Specific columns and counts
cn_columns <- grep("CN", names(Caris_red), value = TRUE)
varcounts_cn <-  colSums(Caris_red %>% dplyr::select(contains("CNA")) != 0)
  
fusion_columns <- grep("Fusion", names(Caris_red), value = TRUE)
varcounts_fusion <-  colSums(Caris_red %>% dplyr::select(contains("Fusion")) != 0)
fusion_pp <- rowSums(Caris_red %>% dplyr::select(contains("Fusion")) != 0)

mut_columns <-  grep("Mutation", names(Caris_red), value = TRUE)
varcounts_mut <-  colSums(Caris_red %>% dplyr::select(contains("Mutation")) != 0)
mutation_pp <- rowSums(Caris_red %>% dplyr::select(contains("Mutation")) != 0)

egfr_columns <-  grep("EGFR", names(Caris_red), value = TRUE)
```

Create per patient sample data frame (pp_df)

```{r}
# Add row sums 
pp_df <- data.frame(Deidentified.code=Caris_red$Deidentified.code, fusions = rowSums(Caris_red %>% dplyr::select(contains("Fusion")) != 0), CNAs = rowSums(Caris_red %>% dplyr::select(contains("CNA")) != 0), muts = rowSums(Caris_red %>% dplyr::select(contains("Mutation")) != 0))

# Add gene information
pp_df<- left_join(pp_df, Caris_red)

# Add clinical
pp_df <- left_join(pp_df, clinical %>% dplyr::select(Deidentified.code, age, sex, kps_at_diagnosis,Seizure.presentation..0.No..1.Yes., Seizure.presentation.ONLY.after.surgery, Seizure.presentation.ANY,Seizure.freq.AVG.over.1st.6.mo, Keppra, Vimpat, Zonegran, Lamictal, race,ki_67, idh1_mutated,mgmt_methylated, p53_percent_reactivity, loc_other, loc_frontal, loc_parietal, loc_occipital, loc_temporal))

# Full
Caris_clinical <- left_join(Caris_red %>% na.omit(), clinical) 
```

```{r}
pp_df <- pp_df %>% mutate(NEL = ifelse(Seizure.presentation..0.No..1.Yes.,"Early", ifelse(Seizure.presentation.ONLY.after.surgery, "Late", "None"))) 

```

Chi-squared test for properties of WES cohort

```{r}
sei_full = c(536, 261, 153) # All patients with No, Early, Late
sei_WES = c(36, 29, 18) # Whole Exome patients with No, Early,Late
sei_diff = sei_full-sei_WES

ctable =matrix(c(sei_diff, sei_WES), ncol=2)
ct = chisq.test(ctable)
print(ct$observed)
print(ct$expected)

```

## LDA Example

```{r}
library(tidyverse)
library(caret)
theme_set(theme_classic())

# Load the data
#data("iris")

# Split the data into training (80%) and test set (20%)
set.seed(123)
training.samples <- pp_df$NEL %>%
  createDataPartition(p = 0.8, list = FALSE)
train.data <- pp_df[training.samples, ]
test.data <- pp_df[-training.samples, ]
#Normalize the data. Categorical variables are automatically ignored.
# Estimate preprocessing parameters
preproc.param <- train.data %>% 
  preProcess(method = c("center", "scale"))
# Transform the data using the estimated parameters
train.transformed <- preproc.param %>% predict(train.data)
test.transformed <- preproc.param %>% predict(test.data)
```

```{r}
library(MASS)
# Fit the model
model <- lda(NEL~kps_at_diagnosis, data = train.transformed,)
# Make predictions
predictions <- model %>% predict(test.transformed)
# Model accuracy
mean(predictions$class==test.transformed$NEL)


model <- lda(Species~., data = train.transformed)
model

# Fit the model
model <- lda(Species~., data = train.transformed)
# Make predictions
predictions <- model %>% predict(test.transformed)
# Model accuracy
mean(predictions$class==test.transformed$Species)
```

Genes in each class

```{r}
length(varcounts_fusion!=0)
length(varcounts_mut!=0)
length(varcounts_cn!=0)

sum(varcounts_fusion!=0)
sum(varcounts_mut!=0)
sum(varcounts_cn!=0)
```

```{r}
cn_top = names((sort(varcounts_cn, decreasing=TRUE)[1:11]))
mut_top = sort(varcounts_mut, decreasing=TRUE)[1:11]
fus_top = sort(varcounts_fusion, decreasing=TRUE)[1:5]

mut_top
```

## Plotting exome variations per sample

```{r}

ggplot(pp_df, aes(y=CNAs, x=as.factor(is.na(p53_percent_reactivity)))) +
  geom_boxplot(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(x='', y = "Frequency") + 
  theme_minimal() 
ggsave(file="fusions.png", width=2, height=4, dpi=300)

```

Validation plot of mutations per sample by MSI, high -\> high mutation number.

```{r, echo=FALSE}
# Create a data frame for ggplot
#pp_df 

# Medians 
summary(pp_df$muts)
summary(pp_df$fusions)
summary(pp_df$CNAs)

# Convert categorical seizure to multi
pp_df$Sz_Pre_Diagnosis = pp_df$Seizure.presentation..0.No..1.Yes.
pp_df <- pp_df |> mutate(CodeSeizure=Sz_Pre_Diagnosis*1 + Seizure.presentation.ONLY.after.surgery*2) |> mutate(CodeSeizure=as.factor(CodeSeizure))


# Wide to Long
pp_df_long <- tidyr::pivot_longer(pp_df, cols=c('muts', 'fusions', 'CNAs'), names_to = "type", values_to = "count")

# Plot histogram of counts within MSI classes
ggplot(pp_df_long, aes(x=MSI, y=count, color=type)) +
  geom_boxplot(alpha = 0.7, notch=TRUE) +
  labs(x='', y = "Count per Sample") 
  #theme_minimal() 


# Plot histogram of counts per sample
ggplot(pp_df_long %>% filter(!is.na(CodeSeizure)), aes(x=type, y=count, col=CodeSeizure)) +
  geom_boxplot(alpha = 0.7, notch=FALSE) +
  labs(x='', y = "Count per Sample")+
  theme_minimal()  + scale_color_discrete(labels=c("No Seizure","Early Seizure","Late Seizure"))+scale_x_discrete(labels=c("Copy Number","Fusions","Mutations"))+labs(colour = "Seizure Incidence", x=c("Variation Type"))

ggsave(file="allCN_mut_fus.png", width=6, height=4, dpi=300)

kruskal.test(count ~ CodeSeizure,data=pp_df_long %>% filter(!is.na(CodeSeizure), type=="fusions"))

kruskal.test(count ~ CodeSeizure,data=pp_df_long %>% filter(!is.na(CodeSeizure), type=="CNAs"))

kruskal.test(count ~ CodeSeizure,data=pp_df_long %>% filter(!is.na(CodeSeizure), type=="muts"))
```

```{r}
ggplot(pp_df, aes(x=fusions, y=muts)) + geom_point(color = "black", alpha = 0.7) + labs(x='', y = "Count per Sample")+ theme_minimal()

cor.test(pp_df$CNAs, pp_df$fusions, method = 'spearman')

cor_matrix = cor(pp_df %>% dplyr::select(c(TMB_numeric,kps_at_diagnosis,Seizure.freq.AVG.over.1st.6.mo, 'muts', 'fusions','CNAs','age')), use = 'pairwise.complete.obs', method = "spearman")
ggcorrplot(cor_matrix, type = 'lower',method = 'square',lab = TRUE,hc.order = TRUE)

ggsave("correlation_GBM.png")

cor_test =cor(pp_df %>% dplyr::select(c(TMB_numeric,'muts', 'fusions','CNAs','age', 'ki_67')) %>% dplyr::mutate(ki_67=as.numeric(ki_67)),use = 'pairwise.complete.obs',method = "spearman")


```

## Heatmaps of exome data

```{r, eval=FALSE}


hm2 = ComplexHeatmap::Heatmap(mut_df,  name = "Mutations", column_names_gp = grid::gpar(fontsize = 6, fontface = "bold"))

hm3 = ComplexHeatmap::Heatmap(fus_df, name = "Fusions", column_names_gp = grid::gpar(fontsize = 6, fontface = "bold"))
hm1 = ComplexHeatmap::Heatmap(cn_df, name = "CN Alterations", column_names_gp = grid::gpar(fontsize = 6, fontface = "bold"), row_title_side = 'left', row_title="",row_dend_reorder = TRUE)

clinical <- clinical %>% filter(!is.na(Seizure.presentation..0.No..1.Yes.))
post_var = as.factor(clinical$Seizure.presentation.ONLY.after.surgery)
pre_var = as.factor(clinical$Seizure.presentation..0.No..1.Yes.)
any_var = as.factor(clinical$Seizure.presentation..0.No..1.Yes. | clinical$Seizure.presentation.ONLY.after.surgery) 


#total_var = reduced_varcounts_pp
burden =log10(clinical$Seizure.freq.AVG.over.1st.6.mo+.01)
ha0 = ComplexHeatmap::rowAnnotation(SeizureBurden=burden) 
ha=ComplexHeatmap::rowAnnotation(Seizure=any_var) 
ha2=ComplexHeatmap::rowAnnotation(Seizure=pre_var) 
#, left_annotation = ha)

ha2 + ha0+ hm1 + hm2 + hm3

#seisure_control = clinical$Any.remission..6mo...end.date - clinical$Any.remission.of.seizure...6mo...start.date
clinical$kps_at_diagnosis
clinical$ki_67
```

```{r}
library(ComplexHeatmap)
first.word <- function(my.string){
    unlist(strsplit(my.string, " "))[1]
}
```

```{r}
mut_top = sub(".Mutation", "", names(mut_top))
fus_top = sub(".Fusion", "", names(fus_top))

mut_df = pp_df %>% dplyr::select(mut_columns) #%>% dplyr::select(-doubleton_mutations)
names(mut_df) = sub(".Mutation*", "", names(mut_df))
cn_df = pp_df %>% dplyr::select(cn_columns) #%>% dplyr::select(-doubleton_cnas)
names(cn_df)=sub(".CNA.CND*", "", names(cn_df))

fus_df = pp_df %>% dplyr::select(fusion_columns) #%>% dplyr::select(-doubleton_fusions)
names(fus_df) = sub(".Fusion*", "", names(fus_df))


```

```{r}


#hm2 = ComplexHeatmap::Heatmap(mut_df,  name = "Mutations", column_names_gp = grid::gpar(fontsize = 6, fontface = "bold"))


#Heatmap(cn_df%>% dplyr::select(-id_cols), name = "mat", column_title = "default reordering")
any_seizure = (clinical$Seizure.presentation..0.No..1.Yes. | clinical$Seizure.presentation.ONLY.after.surgery)
split = ifelse(any_seizure, ifelse(clinical$Seizure.presentation..0.No..1.Yes., 'Early', 'Late'),'None')

cn_colors = c("orange", "slateblue", "yellow","skyblue")
names(cn_colors) = c("Deleted", "Amplified","Intermediate","0")
cn_top = sub(".CNA.CND*", "", cn_top)

#row_dend = dendsort(hclust_cn)
hm_cn = Heatmap(cn_df %>% dplyr::select(cn_top), name = "CN Alterations", row_split=split,
                column_names_gp = gpar(fontsize = 8, fontface = "bold"), #cluster_columns = col_dend,
    column_title = "Copy Number", col=cn_colors)


hm_mut = Heatmap(mut_df %>% dplyr::select(mut_top), name = "Mutations", row_split=split,
                column_names_gp = gpar(fontsize = 8, fontface = "bold"), #cluster_columns = col_dend,
    column_title = "Mutations",col=c("skyblue", "cornflowerblue", "yellow"))

tmi_vals=log(as.numeric(unname(sapply(pp_df$TMB, first.word))))
mgmt_vals = as.factor(as.integer(clinical$mgmt_methylated))

anno_ = rowAnnotation(MGMT=mgmt_vals, LogTMB=tmi_vals)

fusion_colors =c("skyblue", "cornflowerblue", "yellow")
names(fusion_colors) =c("0","Pathogenic Isoform","Unclassified")
hm_fus = Heatmap(fus_df %>% dplyr::select(fus_top[c(1,2)]), name = "Fusions", 
    row_split=split,
    column_names_gp = gpar(fontsize = 8, fontface = "bold"),
    column_title = "Fusions",
    right_annotation = anno_,
    col=fusion_colors)

png(filename = "heatmap_top.png", width=25, height=15, units = "cm", res=250, type = "cairo")

p <- hm_mut+hm_cn + hm_fus
p


#dev.off()
```

```{r}
dim(hm_fus)
length(split)
fus_df[split=="Late",]
```

```{r, fig.width=10, fig.height=10}
library(PerformanceAnalytics)
library(gpairs)
library(GGally)
cont_df = pp_df %>% dplyr::select(c(TMB_numeric,kps_at_diagnosis, Seizure.freq.AVG.over.1st.6.mo, 'muts', 'fusions','CNAs','age', CodeSeizure, mgmt_methylated, sex)) %>% mutate(sex=as.factor(sex)) %>% filter(!is.na(TMB_numeric)) %>% dplyr::rename(TMB=TMB_numeric, SeizureFreq = Seizure.freq.AVG.over.1st.6.mo, KPS=kps_at_diagnosis, Age=age, Mutations=muts, Fusions=fusions)
#chart.Correlation(cont_df, method = "s")
g1=ggpairs(cont_df %>% filter(!is.na(CodeSeizure)) %>% dplyr::select(-c("sex", "mgmt_methylated")), ggplot2::aes(colour=as.factor(CodeSeizure)),upper = list(continuous = wrap("cor", size = 3, method="spearman")))+ theme(axis.text = element_text(size = 8))
ggsave("CorrelationContinuous_GBM_Seizure_Overall.png", plot = g1, dpi=300, width=9, height=9)
```

```{r, eval=FALSE}
#install.packages("PerformanceAnalytics")
library(PerformanceAnalytics)
library(gpairs)
library(GGally)
library(dplyr)
cont_df = pp_df %>% dplyr::select(c(kps_at_diagnosis,Seizure.freq.AVG.over.1st.6.mo, 'muts', 'fusions','CNAs','age', 'ki_67', CodeSeizure, mgmt_methylated, sex)) %>% rename(KPS=kps_at_diagnosis, Seizure.freq = Seizure.freq.AVG.over.1st.6.mo, Mutations=muts, Fusions=fusions, Age=age, Sex=sex) %>% mutate(ki_67=as.numeric(ki_67), Sex=as.factor(Sex))
#chart.Correlation(cont_df, method = "s")

g1=ggpairs(cont_df %>% filter(mgmt_methylated!="Indeterminate", CodeSeizure==0) %>% dplyr::select(-c("mgmt_methylated","Seizure.freq")), ggplot2::aes(colour=as.factor(Sex)),upper = list(continuous = wrap("cor", size = 4, method="spearman")))
ggsave("CorrelationContinuous_GBM_NoSeizure_bySex.png", plot=g1, dpi=300, width=10, height=10)

g2=ggpairs(cont_df %>% filter(mgmt_methylated!="Indeterminate", CodeSeizure %in% c(1,2), Sex==0) %>% dplyr::select(-c("Sex", "mgmt_methylated")), ggplot2::aes(colour=as.factor(CodeSeizure)),upper = list(continuous = wrap("cor", size = 4, method="spearman")))
ggsave("CorrelationContinuous_GBM_Seizures_Sex0.png", plot=g2,dpi=300, width=10, height=10)

g2=ggpairs(cont_df %>% filter(mgmt_methylated!="Indeterminate", CodeSeizure %in% c(1,2), Sex==1) %>% dplyr::select(-c("Sex", "mgmt_methylated")), ggplot2::aes(colour=as.factor(CodeSeizure)),upper = list(continuous = wrap("cor", size = 4, method="spearman")))
ggsave("CorrelationContinuous_GBM_Seizures_Sex1.png", plot=g2,dpi=300, width=10, height=10)
#gpairs(cont_df)
```

```{r, eval=FALSE}
ggpairs(cont_df %>% filter(mgmt_methylated=="0", !is.na(CodeSeizure)) %>% dplyr::select(-c("Sex", "mgmt_methylated")), ggplot2::aes(colour=as.factor(CodeSeizure)),upper = list(continuous = wrap("cor", size = 2.5, method="spearman")))
ggsave("CorrelationContinuous_GBM_Seizure_mgmt0.png", dpi=300, width=10, height=10)

ggpairs(cont_df %>% filter(mgmt_methylated=="1", !is.na(CodeSeizure)) %>% dplyr::select(-c("Sex", "mgmt_methylated")), ggplot2::aes(colour=as.factor(CodeSeizure)),upper = list(continuous = wrap("cor", size = 2.5, method="spearman")))
ggsave("CorrelationContinuous_GBM_Seizure_mgmt1.png", dpi=300, width=10, height=10)


```

```{r}
#Add singleton/doubleton

fusion_cols = pp_df %>% dplyr::select(contains(".Fusion"))
singleton_fusions = names(fusion_cols[colSums(pp_df %>% dplyr::select(contains(".Fusion")) != 0)==1])
pp_df$singleton_fusion = rowSums(pp_df %>% dplyr::select(all_of(singleton_fusions))!=0)
doubleton_fusions = names(fusion_cols[colSums(pp_df %>% dplyr::select(contains(".Fusion")) != 0)==2])
pp_df$doubleton_fusion = rowSums(pp_df %>% dplyr::select(all_of(doubleton_fusions))!=0)

mutation_cols = pp_df %>% dplyr::select(contains("Mutation"))
singleton_mutations = names(mutation_cols[colSums(mutation_cols != 0)==1])
pp_df$singleton_mutation = rowSums(pp_df %>% dplyr::select(all_of(singleton_mutations))!=0)
doubleton_mutations = names(mutation_cols[colSums(mutation_cols != 0)==2])
pp_df$doubleton_mutation = rowSums(pp_df %>% dplyr::select(all_of(doubleton_mutations))!=0)

cna_cols = pp_df %>% dplyr::select(contains("CNA"))
singleton_cnas = names(cna_cols[colSums(cna_cols != 0)==1])
pp_df$singleton_cnas = rowSums(pp_df %>% dplyr::select(all_of(singleton_cnas))!=0)
doubleton_cnas = names(cna_cols[colSums(cna_cols != 0)==2])
pp_df$doubleton_cnas = rowSums(pp_df %>% dplyr::select(all_of(doubleton_cnas))!=0)
```

```{r}
length(singleton_cnas)
length(singleton_fusions)
length(singleton_mutations)
length(doubleton_cnas)
length(doubleton_fusions)
length(doubleton_mutations)
```

```{r}
library(PerformanceAnalytics)
library(gpairs)
singletondoubleton_df = pp_df %>% dplyr::select(c('muts',doubleton_mutation, singleton_mutation, 'fusions',doubleton_fusion,singleton_fusion, 'CNAs', doubleton_cnas, singleton_cnas, kps_at_diagnosis, CodeSeizure, Seizure.freq.AVG.over.1st.6.mo, sex, age, mgmt_methylated)) %>% rename(KPS=kps_at_diagnosis, Sex=sex, Age=age, Mutations=muts, Fusions=fusions, Seizure.freq=Seizure.freq.AVG.over.1st.6.mo) %>% mutate(rare_mut=singleton_mutation+doubleton_mutation, rare_fus = doubleton_fusion+singleton_fusion, rare_cna=doubleton_cnas+singleton_cnas) %>% mutate(rare_fus=rare_fus/sum(rare_fus), rare_mut=rare_mut/sum(rare_mut), rare_cna=rare_cna/sum(rare_cna), rare_all = rare_cna+rare_mut+rare_fus) %>% dplyr::select(rare_all, rare_mut, rare_fus, rare_cna, Age, Sex, KPS, Seizure.freq, CodeSeizure,mgmt_methylated)



#x=ggpairs(singletondoubleton_df %>% filter(Sex==1, !is.na(CodeSeizure)) %>% dplyr::select(-c("Sex", "mgmt_methylated")), ggplot2::aes(colour=as.factor(CodeSeizure)),upper = list(continuous = wrap("cor", size = 2.5, method="spearman")))
#ggpairs(mtcars, columns = 2:4, ggplot2::aes(colour=as.character(am)))
#ggsave("rarevars_sex1CorrelationContinuous_GBM_Seizure.png",plot=x, dpi=300, width=10, height=10)


```

Fisher exact test for association between LOH and frequency of exome variation

```{r}
dat = pp_df %>% dplyr::select(c(LOH, muts)) %>% dplyr::mutate(mut_high=muts>2) %>% na.omit()
table(dat %>% dplyr::select(-muts))
fisher.test(table(dat %>% dplyr::select(-muts)))

dat = pp_df %>% dplyr::select(c(LOH, CNAs)) %>% dplyr::mutate(CNA_any=CNAs>0) %>% na.omit()
table(dat %>% dplyr::select(-CNAs))
fisher.test(table(dat %>% dplyr::select(-CNAs)))

dat = pp_df %>% dplyr::select(c(LOH, fusions)) %>% dplyr::mutate(fus_any=fusions>0) %>% na.omit()
table(dat %>% dplyr::select(-fusions))
fisher.test(table(dat %>% dplyr::select(-fusions)))
```

```{r}
dat = pp_df %>% dplyr::select(c(MSI, muts)) %>% dplyr::mutate(mut_any=muts>2) %>% na.omit()
table(dat %>% dplyr::select(-muts))
fisher.test(table(dat %>% dplyr::select(-muts)))

dat = pp_df %>% dplyr::select(c(MSI, CNAs)) %>% dplyr::mutate(CNA_any=CNAs>0) %>% na.omit()
table(dat %>% dplyr::select(-CNAs))
fisher.test(table(dat %>% dplyr::select(-CNAs)))

dat = pp_df %>% dplyr::select(c(MSI, fusions)) %>% dplyr::mutate(fus_any=fusions>0) %>% na.omit()
table(dat %>% dplyr::select(-fusions))
fisher.test(table(dat %>% dplyr::select(-fusions)))
```

Fisher exact test for any seizures

```{r}
dat = pp_df %>% dplyr::select(c(Seizure.presentation.ANY, muts)) %>% dplyr::mutate(mut_high=muts>5) %>% na.omit()
table(dat %>% dplyr::select(-muts))
fisher.test(table(dat %>% dplyr::select(-muts)))

dat = pp_df %>% dplyr::select(c(Seizure.presentation.ANY, CNAs)) %>% dplyr::mutate(CNA_any=CNAs>0) %>% na.omit()
table(dat %>% dplyr::select(-CNAs))
fisher.test(table(dat %>% dplyr::select(-CNAs)))

dat = pp_df %>% dplyr::select(c(Seizure.presentation.ANY, fusions)) %>% dplyr::mutate(fus_any=fusions>0) %>% na.omit()
table(dat %>% dplyr::select(-fusions))
fisher.test(table(dat %>% dplyr::select(-fusions)))
```

```{r}
dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, EGFR.CNA.CND,EGFR.Fusion )) %>% dplyr::mutate(egfr_any=(EGFR.CNA.CND!=0)|(EGFR.Fusion!=0)) %>% na.omit()
dat_table = table(dat %>% dplyr::select(-c(EGFR.CNA.CND, EGFR.Fusion)))
fisher.test(dat_table)

dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, EGFR.Fusion )) %>% dplyr::mutate(egfr_any=EGFR.Fusion!=0) %>% na.omit()
table(dat %>% dplyr::select(-EGFR.Fusion))
fisher.test(table(dat %>% dplyr::select(-EGFR.Fusion)))

dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, EGFR.Mutation )) %>% dplyr::mutate(egfr_any=EGFR.Mutation!=0) %>% na.omit()
table(dat %>% dplyr::select(-EGFR.Mutation))
fisher.test(table(dat %>% dplyr::select(-EGFR.Mutation)))
```

Grouping rare variants

```{r}
fus_singletons = colSums(Caris %>% dplyr::select(contains("Fusion")) != 0)==1
mut_singletons = colSums(Caris %>% dplyr::select(contains("Mutation")) != 0)==1
CN_singletons = colSums(Caris %>% dplyr::select(contains("CNA")) != 0)==1

fus_doubletons = colSums(Caris %>% dplyr::select(contains("Fusion")) != 0)==2
mut_doubletons = colSums(Caris %>% dplyr::select(contains("Mutation")) != 0)==2
CN_doubletons = colSums(Caris %>% dplyr::select(contains("CNA")) != 0)==2

  
sum(fus_doubletons)
sum(mut_doubletons)
sum(CN_doubletons)

sum(fus_singletons)
sum(mut_singletons)
sum(CN_singletons)
```

```{r}
Caris_clinical$TMB_numeric = as.numeric(substr(Caris_clinical$TMB,1,2))

fusion_cols = Caris_clinical %>% dplyr::select(contains(".Fusion"))
singleton_fusions = names(fusion_cols[colSums(Caris_clinical %>% dplyr::select(contains(".Fusion")) != 0)==1])
Caris_clinical$singleton_fusion = rowSums(Caris_clinical %>% dplyr::select(all_of(singleton_fusions))!=0)
doubleton_fusions = names(fusion_cols[colSums(Caris_clinical %>% dplyr::select(contains(".Fusion")) != 0)==2])
Caris_clinical$doubleton_fusion = rowSums(Caris_clinical %>% dplyr::select(all_of(doubleton_fusions))!=0)

mutation_cols = Caris_clinical %>% dplyr::select(contains("Mutation"))
singleton_mutations = names(mutation_cols[colSums(mutation_cols != 0)==1])
Caris_clinical$singleton_mutation = rowSums(Caris_clinical %>% dplyr::select(all_of(singleton_mutations))!=0)
doubleton_mutations = names(mutation_cols[colSums(mutation_cols != 0)==2])
Caris_clinical$doubleton_mutation = rowSums(Caris_clinical %>% dplyr::select(all_of(doubleton_mutations))!=0)

cna_cols = Caris_clinical %>% dplyr::select(contains("CNA"))
singleton_cnas = names(cna_cols[colSums(cna_cols != 0)==1])
Caris_clinical$singleton_cnas = rowSums(Caris_clinical %>% dplyr::select(all_of(singleton_cnas))!=0)
doubleton_cnas = names(cna_cols[colSums(cna_cols != 0)==2])
Caris_clinical$doubleton_cnas = rowSums(Caris_clinical %>% dplyr::select(all_of(doubleton_cnas))!=0)
```

```{r}
# Rare CNAs
dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, singleton_cnas)) %>% dplyr::mutate(singleton_cnas=singleton_cnas!=0) %>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)

dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, doubleton_cnas)) %>% dplyr::mutate(doubleton_cnas=doubleton_cnas!=0) %>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)
```

```{r}
# Rare fusions
dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, singleton_fusion)) %>% dplyr::mutate(singleton_fusion=singleton_fusion!=0) %>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)

dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, doubleton_fusion)) %>% dplyr::mutate(doubleton_fusion=doubleton_fusion!=0) %>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)
```

```{r}
#Any singletons
dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, singleton_fusion, singleton_mutation, singleton_cnas)) %>% dplyr::mutate(singletons=(singleton_fusion!=0|singleton_mutation!=0|singleton_cnas!=0)) %>% dplyr::select(Seizure.presentation.ANY,singletons) %>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)

#Any doubletons
dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, doubleton_fusion, doubleton_mutation, doubleton_cnas)) %>% dplyr::mutate(doubletons=(doubleton_fusion!=0|doubleton_mutation!=0|doubleton_cnas!=0)) %>% dplyr::select(Seizure.presentation.ANY,doubletons)%>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)
```

```{r}
# Rare mutations
dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, singleton_mutation)) %>% dplyr::mutate(singleton_mutation=singleton_mutation!=0) %>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)

dat = Caris_clinical %>% dplyr::select(c(Seizure.presentation.ANY, doubleton_mutation)) %>% dplyr::mutate(doubleton_mutation=doubleton_mutation!=0) %>% na.omit()
dat_table = table(dat)
print(dat_table)
fisher.test(dat_table)

```

```{r}
multivariable_lm = glm(Seizure.presentation.ONLY.after.surgery ~ 
                     age + 
                     sex +
                     mgmt_methylated +
                     egfr_amplified + 
                     TMB_numeric + 
                     MSI + 
                     LOH, 
                     data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate"), 
                     family = "binomial")

summary(multivariable_lm)
```

```{r}

multivariable_lm = glm(Seizure.presentation..0.No..1.Yes. ~ 
                     #age + 
                     sex + 
                     # age:sex +
                     mgmt_methylated +
                     #egfr_amplified +
                     #TMB_numeric + 
                     #MSI + 
                     #LOH + 
                       1
                      
                     , data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate"), 
                     family = "binomial")

summary(multivariable_lm)

multivariable_lm = glm(Seizure.presentation.ANY ~ 
                     #age + 
                     sex +
                     mgmt_methylated +
                     egfr_amplified +
                     TMB_numeric + 
                     #MSI + 
                     #LOH 
                     1
                      
                     , data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate"), 
                     family = "binomial")

summary(multivariable_lm)

multivariable_lm = glm(Seizure.presentation.ONLY.after.surgery ~ 
                     age + 
                     sex +
                     mgmt_methylated +
                     egfr_amplified +
                     #TMB_numeric + 
                     #MSI + 
                     #LOH + 
                     1, data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate"), 
                     family = "binomial")

summary(multivariable_lm)
```

```{r}
multivariable_lm = glm(Seizure.presentation..0.No..1.Yes. ~ 
                     #age + 
                     #doubleton_mutation +
                     #LOH+
                     #MSI +
                     #TMB_numeric +
    
                     #doubleton_cnas + 
                     #doubleton_fusion + 
                     #singleton_fusion + 
                     #singleton_cnas + 
                     #singleton_mutation + 
                     mgmt_methylated +
                     #egfr_amplified +
                     #loc_parietal + 
                     #loc_occipital + 
                     #loc_other
                     
                     singleton_cnas:doubleton_mutation +
                     1, data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate"), family = "binomial")
                    # singleton_mutation + singleton_cnas + singleton_fusion 
                   

summary(multivariable_lm)
```

```{r}
multivariable_lm = glm( Seizure.presentation..0.No..1.Yes.~ 
                     sex+
                     #doubleton_mutation+
                     #doubleton_mutation:doubleton_cnas+ 
                     #doubleton_fusion + 
                     #singleton_fusion + 
                     #singleton_cnas +
                     #singleton_mutation +
                     singleton_cnas:singleton_mutation + 
                     #egfr_amplified +
                     mgmt_methylated #+
                     #loc_parietal + 
                     #loc_occipital 
                     # + loc_frontal + loc_temporal
                   , data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate"), family = "binomial")
                    # singleton_mutation + singleton_cnas + singleton_fusion 
                   

summary(multivariable_lm)
```

```{r}
multivariable_lm = glm(Seizure.presentation.ONLY.after.surgery~ 
                     age
                     + sex 
                    
                    # Pathology 
                    #+ as.numeric(ki_67) 
                    + as.numeric(p53_percent_reactivity)
                       
                    # Rare variants 
                     #+ doubleton_mutation
                     #+ doubleton_cnas
                     #+ doubleton_fusion  
                     #+ singleton_fusion  
                     #+ singleton_mutation
                     #+ singleton_cnas:singleton_mutation  
                    + singleton_cnas
                    
                    #+as.numeric(TERT.Mutation!=0) 
                    #+as.numeric(EGFR.CNA.CND!=0)
                    #+as.numeric(STK11.CNA.CND!=0)
                    #+as.numeric(PTEN.Mutation!=0)
                    #+as.numeric(TP53.Mutation...564!=0)
                    #+as.numeric(EGFR.Mutation!=0)
                    #+as.numeric(EGFR.Fusion!=0)
                    #+as.numeric(TIMM23B.Fusion!=0)
                    #+as.numeric(MEF2B.CNA.CND!=0)
                    
                    # Existing prognostic 
                    + egfr_amplified 
                    #+ mgmt_methylated 
                    
                    # Location
                    #+ loc_parietal  
                    #+ loc_occipital 
                    + loc_frontal
                    #+ loc_temporal
                   , data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate"), family = "binomial")
                    # singleton_mutation + singleton_cnas + singleton_fusion 
                   

summary(multivariable_lm)
```

```{r}
multivariable_lm = glm(Seizure.presentation..0.No..1.Yes.~ 
                     #age
                     + sex 
                    
                    # Pathology 
                    
                    #+ as.numeric(ki_67)
                    #+ as.numeric(p53_percent_reactivity) 
                       
                    # Rare variants 
                     + doubleton_mutation
                     #+ doubleton_cnas
                     #+ doubleton_fusion:doubleton_cnas
                     #+ singleton_fusion
                     + doubleton_mutation:doubleton_cnas
                     #+ singleton_cnas 

                    
                    #+as.numeric(TERT.Mutation!=0) 
                    #+as.numeric(EGFR.CNA.CND!=0)
                    #+as.numeric(STK11.CNA.CND!=0)
                    +as.numeric(PTEN.Mutation!=0)
                    #+as.numeric(TP53.Mutation...564!=0)
                    #+as.numeric(EGFR.Mutation!=0)
                    #+as.numeric(TIMM23B.Fusion!=0)
                    #+as.numeric(MEF2B.CNA.CND!=0)

                    # Existing prognostic 
                    #+ egfr_amplified
                    + mgmt_methylated 
                    
                    # Combined
                    #+ egfr_amplified:as.numeric(ki_67)
                    #+ loc_occipital:as.numeric(ki_67)
                    #+ as.numeric(PTEN.Mutation!=0):singleton_mutation

                     # Location
                    #+ loc_parietal  
                    + loc_occipital
                    #+ loc_frontal
                    #+ loc_temporal
                   , data = Caris_clinical %>% filter(mgmt_methylated!="Indeterminate", !is.na(p53_percent_reactivity)), family = "binomial")
                    # singleton_mutation + singleton_cnas + singleton_fusion 
                   

summary(multivariable_lm)
```

```{r}
# Example data (you will need to replace this with your actual data)
data <- data.frame(
  Allele = rep(c("11:01", "01:01", "02:01", "03:01", "04:01", "05:01"), 3),
  Population = rep(c(rep("No Seizure", 6), rep("Early Seizure", 6), rep("Late Seizure", 6)),3),
  Frequency = rep(c(0.293, 0.204, 0.155, 0.01, 0.124, 0.214, 0.293, 0.204, 0.155, 0.01, 0.124, 0.214, 0.293, 0.204, 0.155, 0.1, 0.023, 0.214),3),
  HLA = rep(c("HLA-A", "HLA-B", "HLA-C"), each = 18)
)

HLA_df <- pp_df %>% dplyr::select(HLA.A, HLA.B, HLA.C, CodeSeizure)
frequency_df <- HLA_df  %>% mutate(id = row_number()) %>%
  tidyr::pivot_longer(cols = starts_with("HLA"), names_to = "HLA", values_to = "alleles") %>%
  tidyr::separate_rows(alleles, sep = ",") %>%
  mutate(alleles = gsub("'", "", alleles),  # Remove single quotes
         HLA_Type = case_when(
           HLA == "HLA.A" ~ "HLA-A",
           HLA == "HLA.B" ~ "HLA-B",
           HLA == "HLA.C" ~ "HLA-C"
         )) %>%
  group_by(CodeSeizure, alleles, HLA_Type) %>%
  summarise(count = n(), .groups = 'drop') %>%
  # Calculate proportions
  group_by(CodeSeizure, HLA_Type) %>%
  mutate(total = sum(count)) %>%
  ungroup() %>%
  mutate(proportion = count / total) %>%
  dplyr::select(-count, -total) %>%
  # Group low-frequency alleles as "other"
  mutate(alleles = ifelse(proportion < 0.05, "other", alleles)) %>%
  group_by(CodeSeizure, alleles, HLA_Type) %>%
  summarise(proportion = sum(proportion), .groups = 'drop') 


```

```{r}
# Function to create pie charts
plot_pie_chart <- function(df) {
  # Create a rainbow palette for unique alleles
  unique_alleles <- unique(df$alleles[df$alleles != "other"])
  rainbow_colors <- rainbow(length(unique_alleles))
  
  # Create a named vector for the fill colors
  fill_colors <- c(setNames(rainbow_colors, unique_alleles), "other" = "gray")
  
  ggplot(df, aes(x = "", y = proportion, fill = alleles)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y", start = 0) +
    facet_grid(HLA_Type ~ CodeSeizure) + 
    theme_void() +
    theme(strip.text = element_text(face = "bold")) +
    scale_fill_manual(values = fill_colors)
}



# Plot pie charts
plot_pie_chart(frequency_df)

```

```{r}

library(stringr)
pp_df$HLA.A= ifelse(pp_df$HLA.A=='NA',NA,pp_df$HLA.A)
pp_df$HLA.B= ifelse(pp_df$HLA.B=='NA',NA,pp_df$HLA.B)
pp_df$HLA.C= ifelse(pp_df$HLA.C=='NA',NA,pp_df$HLA.C)

library(tidyr)
pp_df_longHLA <- pp_df |>
separate_wider_delim(HLA.A, delim = ",", names = c("HLA.A1", "HLA.A2"), too_few = "align_end")
pp_df_longHLA <- pp_df_longHLA |>
separate_wider_delim(HLA.B, delim = ",", names = c("HLA.B1", "HLA.B2"), too_few = "align_end")
pp_df_longHLA <- pp_df_longHLA |>
separate_wider_delim(HLA.C, delim = ",", names = c("HLA.C1", "HLA.C2"), too_few = "align_end")

pp_df_longHLA <- pp_df_longHLA |> tidyr::pivot_longer(cols=c(HLA.A1, HLA.A2, HLA.B1, HLA.B2, HLA.C1, HLA.C2), names_to = c('HLA'), values_to = "HLA.alleles")

pp_df_longHLA$HLA.alleles = sub('\'','', pp_df_longHLA$HLA.alleles)
```

## Plotting HLA genotype distributions

```{r}
library(patchwork)
# Combine HLA allele columns

allele_combinationsA <- pp_df %>%
  group_by(HLA.A) %>%
  summarize(Frequency = n(), Seizure_Frequency = sum(Seizure.presentation..0.No..1.Yes.)) %>%
  arrange(desc(Frequency))

allele_combinationsB <- pp_df %>%
  group_by(HLA.B) %>%
  summarize(Frequency = n(), Seizure_Frequency = sum(Seizure.presentation..0.No..1.Yes.)) %>%
  arrange(desc(Frequency))

allele_combinationsC <- pp_df %>%
  group_by(HLA.C) %>%
  summarize(Frequency = n(), Seizure_Frequency = sum(Seizure.presentation..0.No..1.Yes.)) %>%
  arrange(desc(Frequency))

# Plot the most frequent allele combinations
plotA <- ggplot(allele_combinationsA  %>%
  filter(Frequency > 1), aes(x = reorder(HLA.A, -Frequency), y = Frequency, fill=Seizure_Frequency/Frequency)) +
  geom_bar(stat = "identity") +
  labs(title="A", x = "Allele Combination", y = "Frequency") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_fill_gradient(low = "blue", high = "red", name = "Seizure Frequency")+
  guides(fill = "none")


plotB <- ggplot(allele_combinationsB  %>%
  filter(Frequency > 1), aes(x = reorder(HLA.B, -Frequency), y = Frequency, fill=Seizure_Frequency/Frequency)) +
  geom_bar(stat = "identity") +
  labs(title="B", x = "Allele Combination", y = "Frequency") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_fill_gradient(low = "blue", high = "red", name = "Seizure Frequency")+
  guides(fill = "none")  + ylim(c(0,5))


plotC <- ggplot(allele_combinationsC %>% filter(Frequency > 1), aes(x = reorder(HLA.C, -Frequency), y = Frequency, fill = Seizure_Frequency / Frequency)) +
  geom_bar(stat = "identity") +
  labs(title="C", x="Allele Combination", y = "Frequency") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_gradient(low = "blue", high = "red", name = "Proportion with \nEarly Seizures") + ylim(c(0,5))



# Combine the plots into a single figure
combined_plot <- plotA + plotB + plotC + plot_layout(nrow = 1)

png(filename = "HLA_combination.png", width=25, height=15, units = "cm", res=250, type = "cairo")

# Display the combined plot
print(combined_plot)


dev.off()
```

```{r}

# Function to separate alleles and calculate frequency
calculate_allele_frequency <- function(data, column_name) {
  # Split the alleles and convert to long format, ensuring unique counts per individual
  alleles <- data %>%
    separate_rows(!!sym(column_name), sep = ",") %>%
    distinct(Deidentified.code, !!sym(column_name), .keep_all = TRUE) %>%
    group_by(Allele = !!sym(column_name)) %>%
    summarize(Frequency = n(), Seizure_Frequency = sum(Seizure.presentation..0.No..1.Yes.)) %>%
    arrange(desc(Frequency))
  
  return(alleles)
}


calculate_allele_hetero <- function(data, column_name) {
  # Split the alleles and convert to long format, ensuring unique counts per individual
  alleles <- data %>%
    separate_rows(!!sym(column_name), sep = ",") %>%
    group_by(Deidentifed.code) %>%
    summarize(Frequency = n(unique(!!sym(column_name))), Seizure_Frequency = sum(Seizure.presentation..0.No..1.Yes.)) %>%
    arrange(desc(Frequency))
  
  return(alleles)
}


# Calculate frequencies for each HLA type
allele_freq_A <- calculate_allele_frequency(pp_df %>% select(Deidentified.code, 
                                                             HLA.A, Seizure.presentation..0.No..1.Yes.), "HLA.A")
allele_freq_B <- calculate_allele_frequency(pp_df %>% select(Deidentified.code, 
                                                             HLA.B, Seizure.presentation..0.No..1.Yes.), "HLA.B")
allele_freq_C <- calculate_allele_frequency(pp_df %>% select(Deidentified.code, 
                                                             HLA.C, Seizure.presentation..0.No..1.Yes.), "HLA.C")

# Combine all frequencies into one data frame
allele_freq <- bind_rows(
  allele_freq_A %>% mutate(HLA_Type = "A"),
  allele_freq_B %>% mutate(HLA_Type = "B"),
  allele_freq_C %>% mutate(HLA_Type = "C")
)

allele_freq <- allele_freq %>% filter(Frequency>2) 

# Plot the most frequent alleles
ggplot(allele_freq, aes(x = reorder(Allele, -Frequency), y = Frequency, fill = Seizure_Frequency/Frequency)) +
  geom_bar(stat = "identity") +
  facet_wrap(~HLA_Type, scales = "free_x") +
  labs(x = "Allele", y= "Frequency") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_gradient(low = "blue", high = "red", name = "Proportion with \nEarly Seizures")

ggsave('HLA_GenotypeIndividual.png', width = 10, height=5, unit="in",dpi=350)



```

Heterozygosity of A,B,C

```{r}
homo_het <- pp_df %>% select(Deidentified.code, HLA.A, Seizure.presentation..0.No..1.Yes.) %>% 
    separate_rows(HLA.A, sep = ",") %>% unique() %>% group_by(Deidentified.code) %>% summarize(Frequency = n())

pp_df$HLAhomo = homo_het$Frequency

homo_het <- pp_df %>% select(Deidentified.code, HLA.B, Seizure.presentation..0.No..1.Yes.) %>% 
    separate_rows(HLA.B, sep = ",") %>% unique() %>% group_by(Deidentified.code) %>% summarize(Frequency = n())

pp_df$HLBhomo = homo_het$Frequency

homo_het <- pp_df %>% select(Deidentified.code, HLA.C, Seizure.presentation..0.No..1.Yes.) %>% 
    separate_rows(HLA.C, sep = ",") %>% unique() %>% group_by(Deidentified.code) %>% summarize(Frequency = n())

pp_df$HLChomo = homo_het$Frequency


```

```{r}
library(forcats)
pp_df_longHLA <- pp_df_longHLA |> mutate(sex=as.factor(sex)) |> mutate(sex=lvls_revalue(sex,c('M','F')))
pp_df_longHLA <- pp_df_longHLA |> mutate(mgmt_methylated=as.factor(mgmt_methylated))
pp_df_longHLA <- pp_df_longHLA |> mutate(mgmt_methylated=lvls_revalue(mgmt_methylated,c('Not Methylated','Methylated','Indeterminate')))
pp_df_longHLA <- pp_df_longHLA |> rename(Sz_Pre_Diagnosis=Seizure.presentation..0.No..1.Yes.)


# Rename, only ever needed once per session
#pp_df_longHLA <- pp_df_longHLA |> mutate(Seizure.presentation=lvls_revalue(Seizure.presentation,c('None', 'Seizures')))
#pp_df_longHLA <- pp_df_longHLA |> mutate(Seizure.presentation=as.factor(Seizure.presentation))
```

```{r}
# Highest frequency to lowest frequency HLA

for (i in c('A','B','C')){ ggplot(pp_df_longHLA %>% na.omit() %>% 
           filter(grepl(i, 
                        HLA.alleles)) %>% 
           filter(mgmt_methylated!='Indeterminate'), 
         aes(y=fct_infreq(HLA.alleles), fill=Seizure.presentation..0.No..1.Yes.)) + 
    geom_bar(position="stack") + 
    facet_grid(mgmt_methylated~sex)+ 
    ylab(paste0('HLA-',i,' Genotype'))
  ggsave(paste0('HLA_Genotype_Dist',i,'.png'), width = 6, height=8)
       }
```

### Table for NGS Sequenced Data

```{r}
#Load package
library(tableone)

#Create a variable list which we want in Table 1
listVars <- c("age", "TMB_numeric", "muts", "fusions", "CNAs")

#Define categorical variables
catVars <- c("sex","Seizure.presentation..0.No..1.Yes.","Seizure.presentation.ONLY.after.surgery", "LOH", "MSI") 

pp_df_tb1 <- pp_df |> filter(!is.na(MSI)) |> dplyr::select(!contains('Mutation')) |> dplyr::select(!ends_with('.Fusion')) |> dplyr::select(!contains('CND')) |> dplyr::select(!TMB) |> mutate(CodeSeizure=Seizure.presentation..0.No..1.Yes.*1 + Seizure.presentation.ONLY.after.surgery*2) |> dplyr::select(!starts_with("Deidentif")) |> mutate(across(catVars, as.factor)) |> mutate(across(starts_with("loc"), as.factor)) |> mutate(across(c(CodeSeizure,race, mgmt_methylated, idh1_mutated), as.factor)) |> mutate(across(ki_67,as.numeric)) |> mutate(HLA.A=grepl(x=HLA.A,pattern="A*02:01"), HLA.B=grepl(x=HLA.B,pattern="B*44"), HLA.C=grepl(x=HLA.C,pattern="C*07")) 

# Create summary table using gtsummary
library(gtsummary)

#table1 <- CreateTableOne(data = pp_df_tb1 %>% dplyr::select(!starts_with('Sei')) ,addOverall = TRUE,includeNA = TRUE, strata ='CodeSeizure' )
table1 <- tbl_summary(
    pp_df_tb1 %>% dplyr::select(!starts_with('Sei')),
    by = CodeSeizure,# split table by group 
    type = list(kps_at_diagnosis ~ "continuous"),
    ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p() # test for a difference between groups

#print(table1)
```

### Export to Word!

```{r}
#table1 <- pp_df%>% dplyr::select(catVars, listVars)
# Load the packages
#library(ReporteRs) # Not maintained
library(magrittr)
library(flextable)
library(officer)


doc <- read_docx()
# The script
doc %>% 
     body_add_flextable(table1 %>%
     as_flex_table(.) %>%
               theme_zebra( odd_body = "#DDDDDD", even_body = "#FFFFFF" ) ) %>%
     print(.,target = "GBMEpilepsytable.docx")
```

### Tumor Mutation Burden and HLA genotype distribution

```{r}

pp_df_longHLA <- pp_df_longHLA |> mutate(TMB_group=lvls_revalue(as.factor(ntile(TMB_numeric,2)), c('High','Low')))

# Rename, only ever needed once per session
#pp_df_longHLA <- pp_df_longHLA |> mutate(Seizure.presentation=lvls_revalue(Seizure.presentation,c('None', 'Seizures')))
#pp_df_longHLA <- pp_df_longHLA |> mutate(Seizure.presentation=as.factor(Seizure.presentation))
#pp_df_longHLA <- pp_df_longHLA |> rename(Pre_Diagnosis_Seizures=Seizure.presentation)


# Highest frequency to lowest frequency (fct_infreq())
for (i in c('A','B','C')){ ggplot(pp_df_longHLA %>% na.omit() %>% 
           filter(grepl(i, 
                        HLA.alleles)) %>% 
           filter(mgmt_methylated!='Indeterminate'), 
         aes(y=fct_infreq(HLA.alleles), fill=TMB_group)) + 
    geom_bar(position="stack") + 
    facet_grid(mgmt_methylated~sex)+ 
    ylab(paste0('HLA-',i,' Genotype'))
  ggsave(paste0('HLA_Genotype_TMB_',i,'.png'), width = 6, height=8)
       }

```

Hierarchical Clustering

```{r}


pp_df_longHLA <- pp_df_longHLA |> mutate(CodeSeizure=Sz_Pre_Diagnosis*1 + Seizure.presentation.ONLY.after.surgery*2) |> mutate(CodeSeizure=as.factor(CodeSeizure))

binary_data <- model.matrix(~ . - 1, data = pp_df_longHLA %>% dplyr::select(-id_cols[1:4]) %>% dplyr::select(contains(".Fusion")) %>% mutate_all(as.factor))

# Calculate Jaccard distance
jaccard_dist <- daisy(binary_data, metric = "gower")

# Perform hierarchical clustering
hclust_result <- hclust(jaccard_dist, method = "complete")

# Create dendrogram
dend <- as.dendrogram(hclust_result)

# Sample labels and corresponding colors
sample_labels <- as.factor(pp_df_longHLA$CodeSeizure)
colors <- c("red", "blue", "green", "orange")

# Assign colors to labels
label_colors <- colors[as.numeric(sample_labels)][hclust_result$order]
#labels_colors(dend) <- label_colors

# Plot dendrogram with colored labels
plot(dend, main = "Hierarchical Clustering Dendrogram (Mutation data)", xlab = "Samples", sub = NULL, horiz = FALSE, )
```

```{r}
# Convert categorical data to binary indicators
pp_df_longHLA <- pp_df_longHLA |> mutate(CodeSeizure=Sz_Pre_Diagnosis*1 + Seizure.presentation.ONLY.after.surgery*2) |> mutate(CodeSeizure=as.factor(CodeSeizure))

binary_data <- model.matrix(~ . - 1, data = pp_df_longHLA %>% dplyr::select(-id_cols[1:4]) %>% dplyr::select(contains("Mutation")) %>% mutate_all(as.factor))

# Calculate Jaccard distance
jaccard_dist <- daisy(binary_data, metric = "gower")

# Perform hierarchical clustering
hclust_result <- hclust(jaccard_dist, method = "complete")

# Create dendrogram
dend <- as.dendrogram(hclust_result)

# Sample labels and corresponding colors
sample_labels <- as.factor(pp_df_longHLA$CodeSeizure)
colors <- c("red", "blue", "green", "orange")

# Assign colors to labels
label_colors <- colors[as.numeric(sample_labels)][hclust_result$order]
#labels_colors(dend) <- label_colors

# Plot dendrogram with colored labels
plot(dend, main = "Hierarchical Clustering Dendrogram (Mutation data)", xlab = "Samples", sub = NULL, horiz = FALSE, )
```

```{r}
# Convert categorical data to binary indicators
pp_df_longHLA <- pp_df_longHLA |> mutate(CodeSeizure=Sz_Pre_Diagnosis*1 + Seizure.presentation.ONLY.after.surgery*2) |> mutate(CodeSeizure=as.factor(CodeSeizure))

binary_data <- model.matrix(~ . - 1, data = pp_df_longHLA %>% dplyr::select(-id_cols[1:4]) %>% dplyr::select(contains("CND")) %>% mutate_all(as.factor))

# Calculate Jaccard distance
jaccard_dist <- daisy(binary_data, metric = "gower")

# Perform hierarchical clustering
hclust_result <- hclust(jaccard_dist, method = "complete")

# Create dendrogram
dend <- as.dendrogram(hclust_result)

# Sample labels and corresponding colors
sample_labels <- as.factor(pp_df_longHLA$CodeSeizure)
colors <- c("red", "blue", "green", "orange")

# Assign colors to labels
label_colors <- colors[as.numeric(sample_labels)][hclust_result$order]
labels_colors(dend) <- label_colors

# Plot dendrogram with colored labels
plot(dend, main = "Hierarchical Clustering Dendrogram (Mutation data)", xlab = "Samples", sub = NULL, horiz = FALSE, )
```

```{r}
# Install and load necessary packages
#install.packages("dendextend")
library(dendextend)

# Convert categorical data to binary indicators
binary_data <- model.matrix(~ . - 1, data = as.data.frame(lapply(pp_df_longHLA %>% dplyr::select(-id_cols[1:4]) %>% dplyr::select(contains("Fusion")), as.factor)))

# Calculate Jaccard distance
jaccard_dist <- daisy(binary_data, metric = "gower")

# Perform hierarchical clustering
hclust_result <- hclust(jaccard_dist, method = "complete")

# Create dendrogram
dend <- as.dendrogram(hclust_result)

# Sample labels and corresponding colors
sample_labels <- as.factor(pp_df_longHLA$CodeSeizure)
colors <- c("red", "blue", "green", "orange")

# Assign colors to labels
label_colors <- colors[as.numeric(sample_labels)][hclust_result$order]
labels_colors(dend) <- label_colors

# Plot dendrogram with colored labels
plot(dend, main = "Hierarchical Clustering Dendrogram (Gene fusion data)", xlab = "Samples", sub = NULL, horiz = FALSE, )
```

Random Forest - not useful (worse than random)

```{r}
# Install and load necessary packages
#install.packages("randomForest")
library(randomForest)

pp_df <- left_join(pp_df, Caris_clinical %>% dplyr::select(c(Deidentified.code,contains("ton"), chemo_tx_cytotoxic, chemo_tx_biol_targ)))

rare_cols <- grep("ton", names(pp_df), value = TRUE)
loc_columns <-  grep("loc", names(pp_df), value = TRUE)
mut_columns <-  grep("Mutation", names(pp_df), value = TRUE)
cn_columns <-  grep("CND", names(pp_df), value = TRUE)

pp_df <- pp_df %>% na.omit()

### Classification column 
pp_df$Class <- as.factor(pp_df$CodeSeizure)

equal_0 <- function(x){ return(x==0)}

### Columns for classification
'c(Class, p53_percent_reactivity, age, ki_67, muts, CNAs, fusions, TMB_numeric, sex, loc_columns, cn_top, fus_top, rare_cols)'

### Test/Train split 
split_index = sample(1:nrow(pp_df %>% dplyr::select(-CodeSeizure)), 0.7*nrow(pp_df %>% dplyr::select(-CodeSeizure)))

train_data = (pp_df %>%  dplyr::select(-c(Deidentified.code,CodeSeizure)))[split_index, ]  %>% dplyr::select(Class, chemo_tx_biol_targ,p53_percent_reactivity, age, ki_67, muts, CNAs, fusions, TMB_numeric, sex, rare_cols, loc_columns, names(fus_top)[1:2], names(cn_top)[1:5], names(mut_top)[1:5]) %>% mutate(across(c(names(fus_top)[1:2], names(cn_top)[1:5], names(mut_top)[1:5]), equal_0))
train_data$ki_67 =as.numeric(train_data$ki_67)

test_data = (pp_df %>% dplyr::select(-c(Deidentified.code,CodeSeizure)))[-split_index, ]  %>% dplyr::select(Class, chemo_tx_biol_targ, loc_columns, p53_percent_reactivity, age, ki_67, muts, CNAs, fusions, TMB_numeric, sex, rare_cols, names(fus_top)[1:2], names(cn_top)[1:5], names(mut_top)[1:5]) %>% mutate(across(c(names(fus_top)[1:2], names(cn_top)[1:5], names(mut_top)[1:5]), equal_0))

test_data$ki_67 =as.numeric(test_data$ki_67)


rf_model <- randomForest(Class ~ ., data = train_data, ntree = 10, max_depth=6, na.action=na.omit)
predictions <- predict(rf_model, test_data)
confusion_matrix <- table(predictions, test_data$Class)
accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
print(confusion_matrix)
print(paste("Accuracy:", round(accuracy, 2)))
print(importance(rf_model))

```

Generalised linear model (glmnet + caret) - not useful

```{r}
set.seed(61)
library(glmnet)
library(caret)

# this method controls everything about training
# we will just set up 10-fold cross validation
trctrl <- trainControl(method = "cv",number=10)

col_zeros = names(which(colSums(train_data==0) == nrow(train_data)))
# we will now train elastic net model
# it will try
enetFit <- train(Class~., data = train_data %>%na.omit() %>% dplyr::select(!col_zeros), 
                 method = "glmnet",  
                 trControl=trctrl,
                 na.action = na.omit,
                 # alpha and lambda paramters to try
                 tuneGrid = data.frame(alpha=0.05,
                                       lambda=seq(0.05,0.9,0.01)))

# best alpha and lambda values by cross-validation accuracy
enetFit$bestTune

#test_data =test_data %>%na.omit() %>% dplyr::select(!col_zeros)

class.res=predict(enetFit,test_data[,-1])
confusionMatrix(test_data$Class,class.res)$overall[1]

confusionMatrix(class.res, test_data$Class)

plot(varImp(enetFit),top=10)

```

## Other plots

```{r}
ggplot(pp_df, aes(y=CNAs, x="Copy Number Alterations")) +
  geom_boxplot(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(x='', y = "Frequency") + 
  theme_minimal() 
ggsave(file="CNAs.png", width=2, height=4, dpi=300)
```

## PVClust (p-values of hierarchical clustering)

```{r}
library(pvclust)
df=as.data.frame(as.data.frame(Caris_red%>% dplyr::select(-c(Deidentified.code, TMB, MSI, LOH, HLA.A, HLA.B, HLA.C, TMB_numeric)) %>% lapply(as.numeric)) %>% sapply(is_na))
m_df = as.matrix(df)
m=m_df*1
result <- pvclust(m, method.dist="binary", method.hclust="average", nboot=1000, parallel=TRUE)
plot(result)
pvrect(result, alpha=0.95)
seplot(result, identify=FALSE)

```

```{r}
# install.packages("dendextend")
library(dendextend)
hc=hclust(dist(df, method="binary"))
dend <- as.dendrogram(hc)
# Like: 
# dend <- small_iris[,-5] %>% dist %>% hclust %>% as.dendrogram

# By default, the dend has no colors to the labels
labels_colors(dend)
## NULL
par(mfrow = c(1,2))
plot(dend, main = "Original dend")

# Let's add some color:
colors_to_use <- as.numeric(pp_df$CodeSeizure)
colors_to_use
## [1] 1 2 3 1 2 3
# But sort them based on their order in dend:
colors_to_use <- colors_to_use[order.dendrogram(dend)]
colors_to_use
## [1] 1 1 2 2 3 3
# Now we can use them
labels_colors(dend) <- colors_to_use
# Now each state has a color
labels_colors(dend) 

##   1   2  51  52 101 102 
##   1   1   2   2   3   3
plot(dend, main = "Colored by Seizure Status")

clusts=cutree(hc, k=4)
clusts = clusts[order.dendrogram(dend)]
M=table(clusts,colors_to_use)
dimnames(M) <- list(Hierarchical = c("1","2", "3","4"),Seizures = c("None", "Early", "Late"))

```
